@model Showtime
@{
    ViewData["Title"] = "Select Seats";
}

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <div class="lg:col-span-2">
        <div class="text-center mb-8">
            <div class="text-red-600 text-2xl font-bold mb-2">Ekrani</div>
            <div class="h-1 bg-red-600 rounded-full"></div>
        </div>

        <div class="flex flex-col items-center gap-2 mb-8" id="seatMap">
            @{
                var rows = Model.Seats.GroupBy(s => s.Row).OrderBy(g => g.Key);
            }
            @foreach (var row in rows)
            {
                <div class="flex items-center gap-2">
                    <span class="w-8 text-center font-bold">@row.Key</span>
                    @foreach (var seat in row.OrderBy(s => s.Number))
                    {
                        <button class="seat-btn w-10 h-10 rounded border-2 
                            @(seat.Status == SeatStatus.Occupied ? "bg-gray-600 border-gray-600 cursor-not-allowed" : 
                              seat.Status == SeatStatus.Selected ? "bg-red-600 border-red-600" : 
                              seat.IsWheelchairAccessible ? "bg-blue-600 border-blue-600" : 
                              "bg-gray-800 border-gray-600 hover:border-red-500")
                            @(seat.Status == SeatStatus.Occupied ? "disabled" : "")
                            data-seat-id="@seat.Id"
                            data-row="@seat.Row"
                            data-number="@seat.Number">
                            @if (seat.IsWheelchairAccessible)
                            {
                                <i class="fas fa-wheelchair text-xs"></i>
                            }
                            else if (seat.Status == SeatStatus.Occupied)
                            {
                                <i class="fas fa-user text-xs"></i>
                            }
                        </button>
                    }
                </div>
            }
        </div>

        <div class="flex gap-4 items-center mb-4">
            <div class="flex items-center gap-2">
                <div class="w-10 h-10 border-2 border-gray-600 bg-gray-800 rounded"></div>
                <span class="text-sm">TE LIRA</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-10 h-10 border-2 border-gray-600 bg-gray-600 rounded"></div>
                <span class="text-sm">E ZENE</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-10 h-10 border-2 border-red-600 bg-red-600 rounded"></div>
                <span class="text-sm">E ZGJEDHUR</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-10 h-10 border-2 border-blue-600 bg-blue-600 rounded">
                    <i class="fas fa-wheelchair text-xs"></i>
                </div>
                <span class="text-sm">VENDI PER KARROCE</span>
            </div>
            <button id="clearBtn" class="ml-auto bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded">PASTRO</button>
        </div>
    </div>

    <div class="lg:col-span-1">
        <div class="bg-gray-800 rounded-lg p-6 sticky top-4">
            <div class="aspect-[2/3] bg-gray-700 rounded mb-4 flex items-center justify-center">
                <i class="fas fa-film text-6xl text-gray-600"></i>
            </div>
            <h3 class="font-bold mb-2">@Model.Movie.Title - @Model.Movie.Genre</h3>
            <p class="text-sm text-gray-400 mb-2">
                <i class="fas fa-map-marker-alt"></i> @Model.CinemaHall.Location
            </p>
            <p class="text-sm text-gray-400 mb-2">
                <i class="fas fa-calendar"></i> @Model.ShowDateTime.ToString("ddd • MMM dd, yyyy • h:mm tt")
            </p>
            <p class="text-sm text-gray-400 mb-4">
                <i class="fas fa-video"></i> @Model.ViewType view
            </p>
            <div class="border-t border-gray-700 pt-4 mb-4">
                <div class="grid grid-cols-3 gap-2 text-sm">
                    <div>
                        <p class="text-gray-400">SALLA</p>
                        <p class="font-bold">@Model.CinemaHall.Name</p>
                    </div>
                    <div>
                        <p class="text-gray-400">ROW</p>
                        <p class="font-bold" id="selectedRow">-</p>
                    </div>
                    <div>
                        <p class="text-gray-400">SEATS</p>
                        <p class="font-bold" id="selectedSeats">-</p>
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-700 pt-4 mb-4">
                <p class="text-sm text-gray-400 mb-1">Çmimi normal: <span id="ticketCount">0</span> X @Model.Price.ToString("F2") €</p>
                <p class="text-xl font-bold">SHUMA TOTALE: <span id="totalPrice">0.00</span> €</p>
            </div>
            <button id="continueBtn" class="w-full bg-red-600 hover:bg-red-700 py-3 rounded font-semibold disabled:bg-gray-600 disabled:cursor-not-allowed" disabled>
                BLI
            </button>
        </div>
    </div>
</div>

@section Scripts {
    @Html.AntiForgeryToken()
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let selectedSeats = [];
        const pricePerTicket = @Model.Price;

        $('.seat-btn').click(function() {
            if ($(this).hasClass('bg-gray-600')) return;
            
            const seatId = $(this).data('seat-id');
            const row = $(this).data('row');
            const number = $(this).data('number');
            
            if ($(this).hasClass('bg-red-600')) {
                selectedSeats = selectedSeats.filter(s => s.id !== seatId);
                $(this).removeClass('bg-red-600 border-red-600').addClass('bg-gray-800 border-gray-600');
            } else {
                selectedSeats.push({ id: seatId, row: row, number: number });
                $(this).removeClass('bg-gray-800 border-gray-600').addClass('bg-red-600 border-red-600');
            }
            
            updateSummary();
        });

        $('#clearBtn').click(function() {
            selectedSeats.forEach(seat => {
                $(`.seat-btn[data-seat-id="${seat.id}"]`).removeClass('bg-red-600 border-red-600').addClass('bg-gray-800 border-gray-600');
            });
            selectedSeats = [];
            updateSummary();
        });

        function updateSummary() {
            const count = selectedSeats.length;
            $('#ticketCount').text(count);
            $('#totalPrice').text((count * pricePerTicket).toFixed(2));
            
            if (selectedSeats.length > 0) {
                const rows = [...new Set(selectedSeats.map(s => s.row))];
                const seats = selectedSeats.map(s => s.number).join(', ');
                $('#selectedRow').text(rows.join(', '));
                $('#selectedSeats').text(seats);
                $('#continueBtn').prop('disabled', false);
            } else {
                $('#selectedRow').text('-');
                $('#selectedSeats').text('-');
                $('#continueBtn').prop('disabled', true);
            }
        }

        $('#continueBtn').click(function() {
            if (selectedSeats.length === 0) {
                alert('Ju lutem zgjidhni të paktën një vend.');
                return;
            }
            
            const seatInfo = selectedSeats.map(s => `${s.row}-${s.number}`);
            
            // Show loading
            $(this).prop('disabled', true).text('Duke procesuar...');
            
            $.ajax({
                url: '/Booking/ReserveSeats',
                method: 'POST',
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                data: {
                    showtimeId: @Model.Id,
                    selectedSeats: seatInfo
                },
                success: function(response) {
                    if (response.success) {
                        window.location.href = '/Booking/Payment';
                    } else {
                        alert(response.message || 'Ndodhi një gabim. Ju lutem provoni përsëri.');
                        $('#continueBtn').prop('disabled', false).text('BLI');
                    }
                },
                error: function() {
                    alert('Ndodhi një gabim. Ju lutem provoni përsëri.');
                    $('#continueBtn').prop('disabled', false).text('BLI');
                }
            });
        });
    </script>
}

